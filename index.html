<!-- 
.%%%%%...%%%%%....%%%%...%%%%%%..%%%%%%..%%%%%%...%%%%...%%%%%%.
.%%..%%..%%..%%..%%..%%..%%........%%....%%......%%........%%...
.%%%%%...%%%%%...%%..%%..%%%%......%%....%%%%.....%%%%.....%%...
.%%......%%..%%..%%..%%..%%........%%....%%..........%%....%%...
.%%......%%..%%...%%%%...%%........%%....%%%%%%...%%%%.....%%...
................................................................
..%%%%....%%%%...%%..%%..........%%%%%%..%%%%%%.................                
.%%..%%..%%..%%..%%%.%%............%%......%%...................                
.%%......%%%%%%..%%.%%%..%%%%%%....%%......%%...................                
.%%..%%..%%..%%..%%..%%............%%......%%...................                
..%%%%...%%..%%..%%..%%..........%%%%%%....%%...................                
................................................................                
-->

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <script>

    window.proftest = {}

    
    // ID этой формы T123
    const ZERO_BLOCK_PROFTEST = "#rec756019498";
    const ZERO_BLOCK_RESULT = "#rec754515338";
    const ZERO_BLOCK_INSERTBUTTON = "#rec754498819";
    const ZERO_BLOCK_RESULT_SECOND = "#rec754560367";

    window.proftest.QUESTIONS = [
      {
        question: "Как часто вы пользуетесь компьютером?",
        progress: "0%",
        answers: [
          "Каждый день работаю на компьютере",
          "Иногда, только в личных целях",
          "Я не умею пользоваться компьютером",
        ] 
      },
      {
        question: "Как вы привыкли решать задачи, которые никогда раньше не делали?",
        progress: "9%",
        answers: [
          "Сначала пробую разобраться самостоятельно",
          "Сразу иду в интернет искать ответы",
          "Сразу спрашиваю человека, который всё знает",
        ] 
      },
      {
        question: "Вы активный пользователь соцсетей?",
        progress: "15%",
        answers: [
          "Да, веду свои соцсети",
          "Средне, не веду соцсети, но слежу за другими",
          "Меня нет в соцсетях",
        ] 
      },
      {
        question: "Как вам давались иностранные языки в школе?",
        progress: "20%",
        answers: [
          "Легко, лучше остальных в классе",
          "Средне, на уровне с остальными",
          "С трудом, не давались",
        ]
      },
      {
        question: "Какое у вас образование?",
        progress: "26%",
        answers: [
          "Высшее (оконченное или еще учусь)",
          "Средне-специальное (оконченное или еще учусь)",
          "Только школьное, учиться не планирую",
        ] 
      },
      {
        question: "Вы можете сами установить программу или игру на компьютер?",
        progress: "30%",
        answers: [
          "Да, легко разбираюсь",
          "Могу, но придется попотеть",
          "Нет, ничего в этом не понимаю",
        ] 
      },
      {
        question: "Как вы обычно ведете себя, если у вас что-то не получается?",
        progress: "35%",
        answers: [
          "Сижу и разбираюсь дальше, пока не получится",
          "Прошу помощи эксперта",
          "Перестаю это делать и бросаю",
        ] 
      },
      {
        question: "Вас в школе называли технарем или гуманитарием?",
        progress: "40%",
        answers: [
          "Технарь",
          "Гуманитарий",
          "И то и другое — мне всё дается",
        ] 
      },
      {
        question: "Как вы относитесь к работе в команде?",
        progress: "46%",
        answers: [
          "Отлично! Люблю работать в команде",
          "Нейтрально, мне всё равно как работать",
          "Не люблю, лучше работать в одиночку",
        ] 
      },
      {
        question: "Как вы относитесь к развитию технологий? Роботы, нейросети и всё остальное.",
        progress: "52%",
        answers: [
          "С интересом, любопытно",
          "Без интереса, нейтрально",
          "Меня это пугает",
        ] 
      },
      {
        question: "Как вы храните личные документы?",
        progress: "58%",
        answers: [
          "Разложены по папкам и категориям",
          "Нет системы хранения, лежат в общей стопке",
        ] 
      },
      {
        question: "Вы умеете концентрироваться на одном деле?",
        progress: "60%",
        answers: [
          "Да, я легко фокусируюсь",
          "Да, но нужны усилия",
          "Не могу долго делать что-то одно",
        ] 
      },
        {
            question: "К какому типу личности вы себя относите больше?",
            progress: "63%",
            answers: [
                "Интроверт. Выбираю уединение, некомфортно общаться с людьми.",
                "Экстраверт. Выбираю общество, некомфортно в уединении.",
                "И то, и другое",
            ]
        },
        {
            question: "Как у вас с самодисциплиной? Только честно :)",
            progress: "65%",
            answers: [
                "Часто опаздываю, задерживаю задачи и переношу сроки, но стараюсь с этим бороться",
                "Часто опаздываю, задерживаю задачи и переношу сроки, но меня это вообще не беспокоит",
                "Я не опаздываю, не задерживаю задачи, умею правильно оценивать время",
            ]
        },
        {
            question: "Как вам комфортнее всего общаться с людьми по работе?",
            progress: "69%",
            answers: [
                "Лично вживую. Дистанционно для меня неудобно (по переписке, телефону или видео-связи)",
                "Дистанционно (по переписке, телефону или видео-связи). Лично вживую для меня неудобно.",
                "Оба варианта удобны",
            ]
        },
        {
            question: "Выберите утверждение, которое больше вам подходит",
            progress: "73%",
            answers: [
                "Я умею адаптироваться к изменениям и позитивно воспринимаю всё новое",
                "Я болезненно реагирую на любые изменения и негативно отношусь к новому",
            ]
        },
        {
            question: "Как вы обычно поступаете в критических ситуациях на работе, когда случилась проблема?",
            progress: "75%",
            answers: [
                "Сначала ищу решение проблемы, потом разбираюсь как так получилось и как это не допустить",
                "Сначала выясняю, как это получилось и кто в этом виноват, потом ищу решение",
            ]
        },
        {
            question: "Выберите утверждение, которое больше вам подходит",
            progress: "80%",
            answers: [
                "Я считаю, что важно уметь договариваться и находить удобный для всех компромисс",
                "Я считаю, что мои интересы важнее и проблемы должны решаться в мою пользу",
            ]
        },
        {
            question: "В каком ритме вам комфортнее работать больше всего?",
            progress: "83%",
            answers: [
                "Когда делаю несколько дел одновременно — мне это легко",
                "Когда я надолго фокусируюсь только на одном деле, не отвлекаясь",
                "Когда я регулярно переключаюсь между разными задачами",
            ]
        },
        {
            question: "Выберите, какая мысль вам ближе?",
            progress: "86%",
            answers: [
                "Считаю, нужно получить навыки один раз и на всю жизнь",
                "Считаю, что нужно постоянно обучаться и обновлять навыки",
            ]
        },

      {
        question: "Вы сейчас понимаете, что такое IT-сфера?",
        progress: "90%",
        answers: [
          "Да, отлично разбираюсь в направлениях",
          "Да, но поверхностно, в общих чертах",
          "Нет, ничего не знаю о сфере",
        ] 
      },
      {
        question: "Почему вас интересует новая сфера и вы решили пройти тест?",
        progress: "95%",
        answers: [
          "Есть острая потребность сменить работу",
          "Хочу поменять работу, но еще сомневаюсь",
          "Просто интерес, работу менять не планирую",
        ] 
      },
      {
        question: "Сколько вам полных лет?",
        progress: "99%",
        answers: [
            "Меньше 18",
            "От 18 до 24",
            "От 25 до 34",
            "От 35 до 45",
            "Больше 45",
        ] 
      }
    ];

    // window.proftest.QUESTIONS = [
    //     {
    //       question: "Я предпочитаю ", 
    //       answers: [
    //         "Работать самостоятельно и не зависеть от других",
    //         "Работать в команде и рассчитывать на помощь коллег",
    //         "Организовывать и контролировать процесс работы",
    //       ],
    //       progress: "0%"
    //     }
    // ];

    window.proftest.RESULT_PROFESSION = [
      {
        title: "Вам подходит IT",
        finalBlocks: [
          "#rec754515372",
          "#rec754525707"
        ],
        dataCheck: [1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        superFinalBlock: "#rec754520671",
        userProggress: 0
      },
      {
        title: "Вам не подходит IT",
        finalBlocks: [
          "#rec754535307",
          "#rec754498823"
        ],
        dataCheck: [0,0,99,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        superFinalBlock: "#rec754498823",
        userProggress: 0
      }
    ];
    
    window.proftest.SPECIALIZED_QUESTIONS = {}
    
    ////
    // Блок логики, которую не хочется пихать в сам тест. Скрытие блоков и сбор UUID'ов.
    ////
    
    document.addEventListener("DOMContentLoaded", function(event) {
      // Как загрузится страничка - скрываем все  функциональные блоки
      [
        ZERO_BLOCK_RESULT,
        ZERO_BLOCK_RESULT_SECOND,
        ZERO_BLOCK_INSERTBUTTON
      ].forEach(b => hide(b));

      // Скрываем все финальные блоки
      window.proftest.RESULT_PROFESSION.forEach(p => {
        p.finalBlocks.forEach(b => hide(b))
      })

      // Скрываем все суперфинальные блоки
      window.proftest.RESULT_PROFESSION.forEach(p => {
        hide(p.superFinalBlock);
      })
    });
    
    // UUID'ы
    let UUIDs = {};
    document.addEventListener("gotLead", (e) => {
      UUIDs['leadUUID'] = e.detail
      UUIDs['exponeaUUID'] = getCookie('__exponea_etc__')

      function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(';').shift();
      }
    })

    // У нас часто меняются инпуты. Это костыль, который не будет блокировать код, если что-то пойдет не так.
    Document.prototype.safeQuerySelector = function(selector) {
      if (document.querySelector(selector) !== null)
        return document.querySelector(selector)
      else 
        return document.createElement('div')
    }

    ////
    // Главные функции. Профтест отдает два ивента - answerPressed и proftestCompleted
    ////

    window.addEventListener("answerPressed", e => {
      // метрики будем слушать тут
    })
    
    window.addEventListener("proftestCompleted", e => {
      let data = e.detail;

      safeDataLayer({
          'event' : 'GTMevent',
          'eventCategory' : 'viewing',
          'eventAction' : 'success',
          'eventLabel' : 'contact_page'
      })
      
      // Убираем профтест
      hide(ZERO_BLOCK_PROFTEST);

            
      // Показываем нужные финальные блоки
      data.professions[0].finalBlocks.forEach(b => show(b))
      
      // Показываем две формы
      show(ZERO_BLOCK_RESULT)
      show(ZERO_BLOCK_RESULT_SECOND)
      // document.safeQuerySelector('.z-proftest-result__1 .tn-atom').innerHTML = data.professions[0].title

      t_lazyload_update();
      
      // Дополняем инпуты форм
      setTimeout(function () {
        const FORM = ZERO_BLOCK_RESULT.replace('rec', 'form');
        const SECOND_FORM = ZERO_BLOCK_RESULT_SECOND.replace('rec', 'form');
        let target_lead = true;
        let televox_import_group_id = '9411' 

        document.safeQuerySelector(`${FORM} input[name="thank-you-page"]`).value = "";
        document.safeQuerySelector(`${FORM} input[name="comment_analytics"]`).value = getResultForAmoCrm(data.professions, data.answers);
        document.safeQuerySelector(`${FORM} input[name="comment"]`).value = getResultForAmoCrmOnlyProfs(data.professions, data.answers);
        document.safeQuerySelector(`${FORM} input[name="target_lead"]`).value = target_lead;
        document.safeQuerySelector(`${FORM} input[name="televox_import_group_id"]`).value = televox_import_group_id;

        document.safeQuerySelector(`${SECOND_FORM} input[name="thank-you-page"]`).value = "";
        document.safeQuerySelector(`${SECOND_FORM} input[name="comment_analytics"]`).value = getResultForAmoCrm(data.professions, data.answers);
        document.safeQuerySelector(`${SECOND_FORM} input[name="comment"]`).value = getResultForAmoCrmOnlyProfs(data.professions, data.answers);
        document.safeQuerySelector(`${SECOND_FORM} input[name="target_lead"]`).value = target_lead;
        document.safeQuerySelector(`${SECOND_FORM} input[name="televox_import_group_id"]`).value = televox_import_group_id;
        
        const updateFn = setInterval(function () {
            if (
                document.safeQuerySelector(FORM).classList.contains("js-send-form-success")
                ||
                document.safeQuerySelector(SECOND_FORM).classList.contains("js-send-form-success")
            ) {
                clearInterval(updateFn);
                
                document.querySelectorAll('.blur').forEach(b => b.style.display = 'none');

                hide(ZERO_BLOCK_RESULT)
                hide(ZERO_BLOCK_RESULT_SECOND)
                show(data.professions[0].superFinalBlock)
                // var evt = new CustomEvent("formFilled", { detail: data.professions[0].title });
                // window.dispatchEvent(evt);
            }
        }, 300);
      }, 2000);
    })
    ////
    // Маленькие хэлперы
    ////

    function show(id) {
      try {
        document.querySelector(id).style.display = 'block'
      } catch {
        console.warn(`не смогли показать блок ${id}`)
      }
    }
    
    function hide(id) {
      try {
        document.querySelector(id).style.display = 'none'
      } catch {
        console.warn(`не смогли скрыть блок ${id}`)
      }
    }

    function getTextUserAnswers(userAnswers) {
      let result = "";
      for (const key in userAnswers) {
        let answer = userAnswers[key]
        let factAnswer = (answer.questionLink.answers[ answer.answerIndex ] ? answer.questionLink.answers[ answer.answerIndex ] : Number(answer.answerIndex)+1)
        result += `  ${answer.questionLink.question}: ${factAnswer}\n`;
      }
      return result;
    }

    function getResultForAmoCrm(professions, userAnswers) {
      let profStr = "";
      professions.forEach((p,i) => profStr += `  Топ-${i+1}: ${p.title} (${p.userProggress}%)\n`);

  return `
  Зарплата: ${professions[0].title}

  Ответы на вопросы:\n${getTextUserAnswers(userAnswers)}
  `;
    }

    function getResultForAmoCrmOnlyProfs(professions, userAnswers) {
      let profStr = "";
      professions.forEach((p,i) => profStr += `  Топ-${i+1}: ${p.title} (${p.userProggress}%)\n`);

  return `
  Зарплата: ${professions[0].title}
  `;
    }

    function safeDataLayer(obj) {
      try {
        dataLayer.push(obj)
      } catch {
        console.warn(`Ошибка добавления в dataLayer`, obj)
      }
    }
    ////
    // Дальше - код от бандлера
    ////

    </script>
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.js"></script>
  </body>
</html>