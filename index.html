<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <script>
      
    //  _______                       ______    __                            __                        ______  
    // /       \                     /      \  /  |                          /  |                      /      \ 
    // $$$$$$$  | ______    ______  /$$$$$$  |_$$ |_     ______    _______  _$$ |_          __     __ /$$$$$$  |
    // $$ |__$$ |/      \  /      \ $$ |_ $$// $$   |   /      \  /       |/ $$   |        /  \   /  |$$ ___$$ |
    // $$    $$//$$$$$$  |/$$$$$$  |$$   |   $$$$$$/   /$$$$$$  |/$$$$$$$/ $$$$$$/         $$  \ /$$/   /   $$< 
    // $$$$$$$/ $$ |  $$/ $$ |  $$ |$$$$/      $$ | __ $$    $$ |$$      \   $$ | __        $$  /$$/   _$$$$$  |
    // $$ |     $$ |      $$ \__$$ |$$ |       $$ |/  |$$$$$$$$/  $$$$$$  |  $$ |/  |        $$ $$/   /  \__$$ |
    // $$ |     $$ |      $$    $$/ $$ |       $$  $$/ $$       |/     $$/   $$  $$/          $$$/    $$    $$/ 
    // $$/      $$/        $$$$$$/  $$/         $$$$/   $$$$$$$/ $$$$$$$/     $$$$/            $/      $$$$$$/  

    window.proftest = {}

    
    // ID этой формы T123
    const ZERO_BLOCK_PROFTEST = "#rec739872187";
    const ZERO_BLOCK_RESULT = "#rec739872195";
    const ZERO_BLOCK_INSERTBUTTON = "#rec739872189";
    const ZERO_BLOCK_RESULT_SECOND = "#rec739928868";

    const ZERO_BLOCK_SUPERSILA = "#rec739913019";
    const ZERO_BLOCK_RAZVIVAITE = "#rec739927854";
    const salaryClass = ".proftest-howMuch"

    window.proftest.QUESTIONS = [
      {
        question: "Работа в команде",
        type: "spectrum-numbers",
        answers: [],
        class: ".blur-1"
      },
      {
        question: "Выполнение задач в срок",
        type: "spectrum-numbers",
        answers: [],
        class: ".blur-2"
      },
      {
        question: "Решение конфликтных ситуаций в команде",
        type: "spectrum-numbers",
        answers: [],
        class: ".blur-3"
      },
      {
        question: "Быстрая обучаемость",
        type: "spectrum-numbers",
        answers: [],
        class: ".blur-4"
      },
      {
        question: "Дисциплинированность",
        type: "spectrum-numbers",
        answers: [],
        class: ".blur-5"
      },
      {
        question: "Критическое мышление",
        type: "spectrum-numbers",
        answers: [],
        class: ".blur-6"
      },
      {
        question: "Умение брать ответственность",
        type: "spectrum-numbers",
        answers: [],
        class: ".blur-7"
      },
      {
        question: "Работа в форс-мажорных и стрессовых ситуациях",
        type: "spectrum-numbers",
        answers: [],
        class: ".blur-8"
      },
      {
        question: "Умение быстро адаптироваться к изменениям",
        type: "spectrum-numbers",
        answers: [],
        class: ".blur-9"
      },
      {
        question: "Последовательность и системность",
        type: "spectrum-numbers",
        answers: [],
        class: ".blur-10"
      },
      {
        question: "Умение признавать ошибки и делать выводы",
        type: "spectrum-numbers",
        answers: [],
        class: ".blur-11"
      },
      {
        question: "Какое у вас образование?", 
        type: "modern-classic",
        answers: [
          "Высшее",
          "Средне-специальное",
          "Только школьное",
          "В процессе получения высшего или средне-специального",
        ]
      },
      {
        question: "Какой у вас сейчас уровень зарплаты?", 
        type: "modern-classic",
        answers: [
          "Ничего не зарабатываю",
          "до 30 000 ",
          "от 30 до 60 тысяч",
          "от 60 до 90 тысяч",
          "от 90 до 120 тысяч",
          "больше 120 тысяч",
        ]
      },
      {
        question: "Сколько вам лет?", 
        type: "modern-classic",
        answers: [
          "От 17 до 23",
          "От 24 до 29",
          "От 30 до 35",
          "От 36 до 40",
          "От 40 до 50",
          "Больше 50",
        ]
      },
      {
        question: "В каком регионе вы сейчас живете?", 
        type: "select",
        answers: [
          "РФ: Столицы — Москва или Санкт-Петербург",
          "РФ: Центральный федеральный округ",
          "РФ: Северо-Западный федеральный округ",
          "РФ: Южный федеральный округ",
          "РФ: Северо-Кавказский федеральный округ",
          "РФ: Приволжский федеральный округ",
          "РФ: Уральский федеральный округ",
          "РФ: Сибирский федеральный округ",
          "РФ: Дальневосточный федеральный округ",
          "Страны СНГ",
          "Не РФ, не СНГ, другая зарубежная страна",
        ]
      },
      {
        question: "Рассматриваете ли вы получение новых навыков для роста зарплаты?", 
        type: "modern-classic",
        answers: [
          "Нет, не рассматриваю",
          "Рассматриваю, но в последнюю очередь",
          "Да, рассматриваю, без этого никуда",
        ]
      }
    ];

    window.proftest.RESULT_PROFESSION = [
      {
          title: "От 60 000 до 80 000 ₽",
          dataCheck: [2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,2,2,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          userProggress: 0,
          finalBlocks: [
              "#rec739872197",
              "#rec739891888",
              "#rec739913019",
              "#rec739927854",

          ],
      },
      {
          title: "От 70 000 до 100 000 ₽",
          dataCheck: [0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,2,2,2,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          userProggress: 0,
          finalBlocks: [
              "#rec739872197",
              "#rec739891888",
              "#rec739913019",
              "#rec739927854",

          ],
      },
      {
          title: "от 100 000 ₽",
          dataCheck: [0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,0,0,0,2,2,2,2,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
          userProggress: 0,
          finalBlocks: [
              "#rec739872197",
              "#rec739891888",
              "#rec739913019",
              "#rec739927854",

          ],
      },
    ]
    
    ////
    // Блок логики, которую не хочется пихать в сам тест. Скрытие блоков и сбор UUID'ов.
    ////
    
    document.addEventListener("DOMContentLoaded", function(event) {
      // Как загрузится страничка - скрываем все  функциональные блоки
      [
        ZERO_BLOCK_RESULT,
        ZERO_BLOCK_RESULT_SECOND,
        ZERO_BLOCK_INSERTBUTTON
      ].forEach(b => hide(b));

      // Скрываем все финальные блоки
      window.proftest.RESULT_PROFESSION.forEach(p => {
        p.finalBlocks.forEach(b => hide(b))
      })
      
      
    });
    
    // UUID'ы
    let UUIDs = {};
    document.addEventListener("gotLead", (e) => {
      UUIDs['leadUUID'] = e.detail
      UUIDs['exponeaUUID'] = getCookie('__exponea_etc__')

      function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(';').shift();
      }
    })

    // У нас часто меняются инпуты. Это костыль, который не будет блокировать код, если что-то пойдет не так.
    Document.prototype.safeQuerySelector = function(selector) {
      if (document.querySelector(selector) !== null)
        return document.querySelector(selector)
      else 
        return document.createElement('div')
    }

    ////
    // Главные функции. Профтест отдает два ивента - answerPressed и proftestCompleted
    ////

    window.addEventListener("answerPressed", e => {
      // метрики будем слушать тут
    })
    
    window.addEventListener("proftestCompleted", e => {
      safeDataLayer({
          'event' : 'GTMevent',
          'eventCategory' : 'viewing',
          'eventAction' : 'success',
          'eventLabel' : 'contact_page'
      })
      
      // Убираем профтест
      hide(ZERO_BLOCK_PROFTEST);
      
      let data = e.detail; 
      // Показываем нужные финальные блоки
      data.professions[0].finalBlocks.forEach(b => show(b))
      
      // Показываем две формы
      show(ZERO_BLOCK_RESULT)
      show(ZERO_BLOCK_RESULT_SECOND)
      t_lazyload_update();
      
      // подставим значение зп
      document.safeQuerySelector(`${salaryClass} .tn-atom`).innerHTML = data.professions[0].title

      // сначала заблюрим все признаки
      for (const key in data.answers) 
        document.querySelectorAll(`${data.answers[key].questionLink.class}`).forEach(b => b.classList.add("blur-for-marks"))
      
      // Дополняем инпуты форм
      setTimeout(function () {
        const FORM = ZERO_BLOCK_RESULT.replace('rec', 'form');
        const SECOND_FORM = ZERO_BLOCK_RESULT_SECOND.replace('rec', 'form');
        let target_lead = true;
        let televox_import_group_id = '9128' 

        document.safeQuerySelector(`${FORM} input[name="thank-you-page"]`).value = "";
        document.safeQuerySelector(`${FORM} input[name="comment_analytics"]`).value = getResultForAmoCrm(data.professions, data.answers);
        document.safeQuerySelector(`${FORM} input[name="comment"]`).value = getResultForAmoCrmOnlyProfs(data.professions, data.answers);
        document.safeQuerySelector(`${FORM} input[name="target_lead"]`).value = target_lead;
        document.safeQuerySelector(`${FORM} input[name="televox_import_group_id"]`).value = televox_import_group_id;

        document.safeQuerySelector(`${SECOND_FORM} input[name="thank-you-page"]`).value = "";
        document.safeQuerySelector(`${SECOND_FORM} input[name="comment_analytics"]`).value = getResultForAmoCrm(data.professions, data.answers);
        document.safeQuerySelector(`${SECOND_FORM} input[name="comment"]`).value = getResultForAmoCrmOnlyProfs(data.professions, data.answers);
        document.safeQuerySelector(`${SECOND_FORM} input[name="target_lead"]`).value = target_lead;
        document.safeQuerySelector(`${SECOND_FORM} input[name="televox_import_group_id"]`).value = televox_import_group_id;
        
        const updateFn = setInterval(function () {
            if (
                document.safeQuerySelector(FORM).classList.contains("js-send-form-success")
                ||
                document.safeQuerySelector(SECOND_FORM).classList.contains("js-send-form-success")
            ) {
                clearInterval(updateFn);
                
                document.querySelectorAll('.blur').forEach(b => b.style.display = 'none');

                // потом пройдемся и анблюрнем те, что нужны
                for (const key in data.answers) {
                  let a = data.answers[key]
                  a.answerIndex = Number(a.answerIndex)
                  
                  if (a.questionLink.type !== "spectrum-numbers") continue;
                  if ([3,4].includes(a.answerIndex)) document.safeQuerySelector(`${ZERO_BLOCK_SUPERSILA} ${a.questionLink.class}`).classList.remove("blur-for-marks")
                  if ([0,1].includes(a.answerIndex)) document.safeQuerySelector(`${ZERO_BLOCK_RAZVIVAITE} ${a.questionLink.class}`).classList.remove("blur-for-marks")
                }
              
                hide(ZERO_BLOCK_RESULT)
                hide(ZERO_BLOCK_RESULT_SECOND)
            }
        }, 300);
      }, 2000);
    })
    
    ////
    // Маленькие хэлперы
    ////

    function show(id) {
      try {
        document.querySelector(id).style.display = 'block'
      } catch {
        console.warn(`не смогли показать блок ${id}`)
      }
    }
    
    function hide(id) {
      try {
        document.querySelector(id).style.display = 'none'
      } catch {
        console.warn(`не смогли скрыть блок ${id}`)
      }
    }

    function getTextUserAnswers(userAnswers) {
      let result = "";
      for (const key in userAnswers) {
        let answer = userAnswers[key]
        result += `${answer.questionLink.question}: ${answer.questionLink.answers[ answer.answerIndex ]}\n`;
      }
      return result;
    }

    function getResultForAmoCrm(professions, userAnswers) {
      let profStr = "";
      professions.forEach((p,i) => profStr += `Топ-${i+1}: p.title (${p.userProggress}%)\n`);

  return `
  Результат:
  ${profStr}

  Ответы на вопросы:
  ${getTextUserAnswers(userAnswers)}
  `;
    }

    function getResultForAmoCrmOnlyProfs(professions, userAnswers) {
      let profStr = "";
      professions.forEach((p,i) => profStr += `Топ-${i+1}: p.title (${p.userProggress}%)\n`);

  return `
  Результат:
  ${profStr}
  `;
    }

    function safeDataLayer(obj) {
      try {
        dataLayer.push(obj)
      } catch {
        console.warn(`Ошибка добавления в dataLayer`, obj)
      }
    }
    ////
    // Дальше - код от бандлера
    ////

    </script>
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.js"></script>
  </body>
</html>